{% extends "base.html" %}
{% block page_title %}Check-in Approval{% endblock %}
{% block content %}
    <div id="visitor-details" style="display:none;" class="card p-4 mt-3 shadow-sm">
        <h3 class="card-title text-center mb-4" style="color: #007bff; font-weight: bold;">Visitor Check-in Details</h3>
        <div id="printable-id-card" class="id-card-container p-4 mb-3 border rounded shadow" style="max-width: 400px; margin: auto; text-align: center; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #007bff;">
            <div style="background-color: #007bff; color: white; padding: 10px; margin: -1rem -1rem 1rem -1rem; border-radius: 0.25rem 0.25rem 0 0;">
                <h5 class="mb-0" style="font-weight: bold;">VISITOR ID CARD</h5>
            </div>
            <div id="visitor-image-container" style="display:none; margin-bottom: 15px;">
                <img id="visitor-image" src="" alt="Visitor Image" class="rounded-circle shadow" style="width: 140px; height: 140px; object-fit: cover; border: 4px solid #007bff;">
            </div>
            <h4 id="visitor-name" class="mb-2" style="color: #343a40; font-weight: bold; font-size: 1.5rem;"></h4>
            <p id="visitor-mobile" class="mb-1" style="font-size: 1.1rem; color: #495057;"><i class="fas fa-phone"></i> <span></span></p>
            <p id="visitor-purpose" class="mb-3" style="font-size: 1rem; color: #6c757d; font-style: italic;"></p>
            <div id="work-permit-container" style="margin-top: 10px; padding: 10px; background-color: #f0f8ff; border-radius: 5px; border-left: 4px solid #007bff; display: none;">
                <p id="work-permit-info" class="mb-1" style="font-size: 0.9rem; color: #495057;"><i class="fas fa-file-alt me-2"></i><strong>Work Permit Certificate:</strong> <span id="work-permit-value"></span></p>
            </div>
            <div id="qr-code-container" style="display:none; margin-top: 20px; padding: 15px; background-color: white; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <img id="qr-code-image" src="" alt="QR Code" style="width: 180px; height: 180px;">
                <p class="mt-2 mb-0" style="font-weight: bold; color: #007bff; font-size: 1.1rem;">Visitor ID: <span id="visitor-visitor-id"></span></p>
            </div>
        </div>

        <!-- Work Permit Certificate Upload Form for Vendor Services -->
        <div id="work-permit-upload" style="display:none; margin-top: 20px; padding: 20px; border: 2px dashed #007bff; border-radius: 10px; background-color: #f8f9ff;">
            <h5 class="text-center mb-3" style="color: #007bff;">Work Permit Certificate Required</h5>
            <p class="text-center mb-3">This visitor has purpose "Vendor Service" and requires a work permit certificate.</p>
            
            <!-- File Upload Option -->
            <div class="form-group">
                <label for="work_permit_certificate" class="form-label">Upload Work Permit Certificate: <span class="text-danger">*</span></label>
                <input type="file" class="form-control" id="work_permit_certificate" name="work_permit_certificate" accept=".png,.jpg,.jpeg,.gif,.pdf" required>
                <small class="form-text text-muted">Accepted formats: PNG, JPG, JPEG, GIF, PDF. Maximum file size: 5MB. <span class="text-danger">*</span> Required for vendor service visitors</small>
            </div>
            
            <!-- Safety Measures Checklist Upload -->
            <div class="form-group">
                <label for="safety_measures_checklist" class="form-label">Upload Safety Measures Checklist: <span class="text-danger">*</span></label>
                <input type="file" class="form-control" id="safety_measures_checklist" name="safety_measures_checklist" accept=".png,.jpg,.jpeg,.gif,.pdf" required>
                <small class="form-text text-muted">Accepted formats: PNG, JPG, JPEG, GIF, PDF. Maximum file size: 5MB. <span class="text-danger">*</span> Required for vendor service visitors</small>
            </div>
            
            <!-- Camera Option -->
            <div class="form-group">
                <label class="form-label">Or take a photo of the document:</label>
                <div class="d-flex flex-column align-items-center">
                    <video id="workPermitVideo" width="320" height="240" style="border: 1px solid #ddd; margin-bottom: 10px; display: none;"></video>
                    <button type="button" id="start-workPermit-camera" class="btn btn-outline-primary mb-2">Start Camera</button>
                    <canvas id="workPermitCanvas" width="320" height="240" style="display: none;"></canvas>
                    <button type="button" id="capture-workPermit-photo" class="btn btn-outline-success mb-2" style="display: none;">Capture Photo</button>
                    <img id="workPermitPreview" style="display: none; max-width: 100%; margin-top: 10px;" alt="Captured document preview">
                    <input type="hidden" id="workPermitCapturedImage" name="work_permit_captured_image">
                </div>
            </div>
            
            <!-- Safety Measures Checklist Camera Option -->
            <div class="form-group">
                <label class="form-label">Or take a photo of the Safety Measures Checklist:</label>
                <div class="d-flex flex-column align-items-center">
                    <video id="safetyMeasuresVideo" width="320" height="240" style="border: 1px solid #ddd; margin-bottom: 10px; display: none;"></video>
                    <button type="button" id="start-safetyMeasures-camera" class="btn btn-outline-primary mb-2">Start Camera</button>
                    <canvas id="safetyMeasuresCanvas" width="320" height="240" style="display: none;"></canvas>
                    <button type="button" id="capture-safetyMeasures-photo" class="btn btn-outline-success mb-2" style="display: none;">Capture Photo</button>
                    <img id="safetyMeasuresPreview" style="display: none; max-width: 100%; margin-top: 10px;" alt="Captured safety measures checklist preview">
                    <input type="hidden" id="safetyMeasuresCapturedImage" name="safety_measures_captured_image">
                </div>
            </div>
            
            <div class="d-flex justify-content-center mt-3">
                <button id="upload-work-permit-button" class="btn btn-primary">Upload Certificate</button>
            </div>
        </div>

        <!-- Other visitor details hidden - only showing ID card for check-in -->
        <div class="d-flex justify-content-between mt-3">
            <div>
                <button id="cancel-button" class="btn btn-secondary mr-2">Cancel</button>
                <button id="reject-button" class="btn btn-danger" style="display:none;">Reject Visitor</button>
            </div>
            <div>
                <button id="print-id-card-button" class="btn btn-info mr-2" style="display:none;">Print ID Card</button>
                <button id="confirm-check-in-button" class="btn btn-success" style="display:none;">Confirm Check-in</button>
            </div>
        </div>
    </div>

    <button id="check-in-button" class="btn btn-success mb-3">Scan QR for Check-in</button>
    
    <!-- Manual Test Input for Debugging -->
    <div class="card mb-3 bg-light">
        <div class="card-body">
            <h6 class="mb-2">üîß Debug: Manual Visitor ID Test</h6>
            <div class="input-group" style="max-width: 400px;">
                <input type="text" id="manual-visitor-id" class="form-control" placeholder="Enter Visitor ID to test">
                <button id="manual-test-button" class="btn btn-primary">Test Lookup</button>
            </div>
        </div>
    </div>
    
    <form method="GET" class="form-inline mb-3" id="searchForm">
        <div class="form-group mx-sm-3 mb-2">
            <input type="text" class="form-control" id="searchTermInput" name="search_term" placeholder="Search by Name or Visitor ID">
        </div>
        <button type="submit" class="btn btn-primary mb-2">Search</button>
        <button type="button" class="btn btn-secondary mb-2 ml-2" id="clearSearchButton">Clear</button>
    </form>

    <div id="qr-scanner-container" style="display:none; text-align: center; margin-top: 20px; max-width: 700px; margin-left: auto; margin-right: auto;">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-qrcode me-2"></i>Scan Visitor QR Code</h4>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Instructions:</strong> Position the QR code within the square box. The scanner will automatically detect and read it.
                </div>
                <div id="qr-reader" style="width: 100%; margin: 10px auto; border-radius: 10px; overflow: hidden;"></div>
                <button id="stop-scan-button" class="btn btn-danger mt-3">
                    <i class="fas fa-stop-circle me-2"></i>Stop Scanning
                </button>
            </div>
        </div>
    </div>

    <h3 class="mt-4">Approved Visitors</h3>
    {% if approved_visitors %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Visitor ID</th>
                        <th>Unit</th>
                        <th>Host</th>
                        <th>Purpose</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for visitor in approved_visitors %}
                        <tr>
                            <td>{{ visitor.name }}</td>
                            <td>{{ visitor.Visitor_ID }}</td>
                            <td>{{ visitor.unit }}</td>
                            <td>{{ visitor.host.username }}</td>
                            <td>{{ visitor.purpose }}</td>
                            <td>{{ visitor.status }}</td>
                            <td>
                                <button class="btn btn-sm btn-info view-details-btn" data-visitor-id="{{ visitor.original_visitor_id }}">View Details</button>
                                <button type="button" class="btn btn-sm btn-success check-in-table-btn" data-visitor-id="{{ visitor.original_visitor_id }}">Check-in</button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>No approved visitors found.</p>
    {% endif %}

    <script src="https://unpkg.com/html5-qrcode@2.3.7/html5-qrcode.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
        const visitorDetailsDiv = document.getElementById('visitor-details');
        const checkInButton = document.getElementById('check-in-button');
        const cancelButton = document.getElementById('cancel-button');
        const viewDetailsButtons = document.querySelectorAll('.view-details-btn');
        const qrScannerContainer = document.getElementById('qr-scanner-container');
        const stopScanButton = document.getElementById('stop-scan-button');
        const confirmCheckInButton = document.getElementById('confirm-check-in-button');
        const rejectButton = document.getElementById('reject-button');
        const checkInTableButtons = document.querySelectorAll('.check-in-table-btn');
        const manualTestButton = document.getElementById('manual-test-button');
        const manualVisitorIdInput = document.getElementById('manual-visitor-id');

        let html5QrCode = null; // To hold the Html5Qrcode scanner instance
        let currentVisitorId = null; // To store the visitor ID for OK/Cancel actions

        // Ensure initial state is correct
        visitorDetailsDiv.style.display = 'none';
        checkInButton.style.display = 'block';
        cancelButton.style.display = 'none';
        confirmCheckInButton.style.display = 'none';
        rejectButton.style.display = 'none';
        qrScannerContainer.style.display = 'none';

        // Manual test button handler for debugging
        manualTestButton.addEventListener('click', () => {
            const testId = manualVisitorIdInput.value.trim();
            if (testId) {
                console.log('üß™ MANUAL TEST - Testing with Visitor ID:', testId);
                fetchVisitorDetailsAndShowActions(testId);
            } else {
                alert('Please enter a Visitor ID to test');
            }
        });

        // Function to start the QR scanner
        async function startQrScanner() {
            console.log("startQrScanner called.");
            
            try {
                qrScannerContainer.style.display = 'block';
                checkInButton.style.display = 'none';
                
                html5QrCode = new Html5Qrcode("qr-reader");
                
                // Improved configuration for better scanning
                const config = {
                    fps: 10, // Reduced FPS for better stability
                    qrbox: function(viewfinderWidth, viewfinderHeight) {
                        // More conservative QR box sizing
                        let minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                        let qrboxSize = Math.floor(minEdge * 0.5); // Reduced from 0.7 to 0.5
                        return {
                            width: qrboxSize,
                            height: qrboxSize
                        };
                    },
                    // Remove aspectRatio to allow better camera compatibility
                    disableFlip: false, // Allow both orientations
                    videoConstraints: {
                        facingMode: { ideal: "environment" }, // Prefer back camera
                        width: { ideal: 640 }, // Reduced resolution for better performance
                        height: { ideal: 480 } // Reduced resolution for better performance
                    },
                    // Add experimental settings for better performance
                    experimentalFeatures: {
                        useBarCodeDetectorIfSupported: true // Use built-in BarcodeDetector if available
                    }
                };
                
                await html5QrCode.start(
                    { facingMode: "environment" }, // Use back camera on mobile
                    config,
                    (decodedText, decodedResult) => {
                        console.log("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ");
                        console.log("‚úÖ QR CODE SCAN SUCCESS!");
                        console.log("üì± Decoded Text:", decodedText);
                        console.log("üìä Decoded Text Type:", typeof decodedText);
                        console.log("üìè Decoded Text Length:", decodedText.length);
                        console.log("üî¢ Decoded Text as String:", String(decodedText));
                        console.log("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ");
                        stopQrScanner();
                        fetchVisitorDetailsAndShowActions(decodedText);
                    },
                    (errorMessage) => {
                        // Scanning error - this is normal, just means no QR code detected yet
                        // Don't log every frame's error to avoid console spam
                        // Only log errors that are not "QR code not found" which is expected
                        if (!errorMessage.includes("QR code not found")) {
                            console.warn("QR Scanner Warning:", errorMessage);
                        }
                    }
                );
                
                console.log("‚úÖ QR Scanner started successfully - Point camera at QR code");
            } catch (err) {
                console.error("‚ùå Error starting QR scanner:", err);
                let errorMessage = "Error accessing camera. Please ensure you have a camera and have granted permission.";
                
                if (err.toString().includes('NotAllowedError')) {
                    errorMessage = "Camera access denied. Please allow camera permissions in your browser settings and try again.";
                } else if (err.toString().includes('NotFoundError')) {
                    errorMessage = "No camera found. Please ensure a camera is connected to your device.";
                } else if (err.toString().includes('NotReadableError')) {
                    errorMessage = "Camera is already in use by another application. Please close other applications using the camera.";
                }
                
                alert(errorMessage);
                qrScannerContainer.style.display = 'none';
                checkInButton.style.display = 'block';
            }
        }

        // Function to stop the QR scanner
        async function stopQrScanner() {
            if (html5QrCode) {
                try {
                    await html5QrCode.stop();
                    html5QrCode.clear();
                    console.log("QR Scanner stopped");
                } catch (err) {
                    console.error("Error stopping QR scanner:", err);
                }
            }
            qrScannerContainer.style.display = 'none';
            checkInButton.style.display = 'block';
        }
        
        // Event listener for stop scan button
        stopScanButton.addEventListener('click', () => {
            stopQrScanner();
        });

        // Function to fetch visitor details and show OK/Cancel buttons
        async function fetchVisitorDetailsAndShowActions(visitorId) {
            console.log("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ");
            console.log("üîç FETCHING VISITOR DETAILS");
            console.log("üìù Visitor ID Parameter:", visitorId);
            console.log("üìù Visitor ID Type:", typeof visitorId);
            console.log("üåê API URL:", `/vms/get_visitor_details/${visitorId}`);
            console.log("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ");

            try {
                // Add a small delay to allow camera to fully stop before making request
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const response = await fetch(`/vms/get_visitor_details/${visitorId}`, {
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    // Add timeout to prevent hanging requests
                    signal: AbortSignal.timeout(10000) // 10 second timeout
                });
                console.log("üì° Response Status:", response.status);
                console.log("üì° Response OK:", response.ok);
                console.log("üì° Response Content-Type:", response.headers.get('content-type'));

                let data;
                try {
                    if (response.headers.get('content-type')?.includes('application/json')) {
                        data = await response.json();
                        console.log("üì¶ Response Data:", data);
                    } else {
                        const text = await response.text();
                        console.error("‚ùå Non-JSON response received:", text);
                        throw new Error("Non-JSON response received from server.");
                    }
                } catch (e) {
                    console.error("‚ùå Error parsing response:", e);
                    alert("Error parsing response from server. Please check the console for details.");
                    visitorDetailsDiv.style.display = 'none';
                    document.getElementById('print-id-card-button').style.display = 'none';
                    return;
                }
                
                if (response.ok && data.success !== false) { // Check for response.ok and explicit success flag
                    console.log("‚úÖ Visitor found successfully!");
                    // Populate visitor details for ID card
                    document.getElementById('visitor-name').innerText = data.name || '';
                    document.querySelector('#visitor-mobile span').innerText = data.mobile || '';
                    document.getElementById('visitor-purpose').innerText = data.purpose || '';
                    document.getElementById('visitor-visitor-id').innerText = data.Visitor_ID || '';
                    
                    // Show Work Permit Certificate if visitor purpose is Vendor Service
                    const workPermitContainer = document.getElementById('work-permit-container');
                    const workPermitValue = document.getElementById('work-permit-value');
                    if (data.purpose && data.purpose.includes('Vendor Service')) {
                        if (data.work_permit_certificate) {
                            // Create a link to view the work permit certificate
                            const link = document.createElement('a');
                            link.href = `/vms/uploads/${data.work_permit_certificate}`;
                            link.target = '_blank';
                            link.className = 'btn btn-sm btn-outline-primary';
                            link.innerHTML = '<i class="fas fa-external-link-alt me-1"></i>View Document';
                            
                            // Clear the container and add the link
                            workPermitValue.innerHTML = '';
                            workPermitValue.appendChild(link);
                            workPermitContainer.style.display = 'block';
                        } else {
                            workPermitValue.innerText = 'Not uploaded';
                            workPermitContainer.style.display = 'block';
                        }
                    } else {
                        workPermitContainer.style.display = 'none';
                    }
                
                    // Display visitor image if available
                    const visitorImage = document.getElementById('visitor-image');
                    const visitorImageContainer = document.getElementById('visitor-image-container');
                    if (data.visitor_image) {
                        // Use the public route for visitor images to avoid authentication issues
                        visitorImage.src = `/vms/public_visitor_image/${data.Visitor_ID}/photo`;
                        visitorImageContainer.style.display = 'block';
                    } else {
                        visitorImageContainer.style.display = 'none';
                    }
                    const qrCodeImage = document.getElementById('qr-code-image');
                    const qrCodeContainer = document.getElementById('qr-code-container');
                    if (data.qr_code_url) {
                        qrCodeImage.src = data.qr_code_url;
                        qrCodeContainer.style.display = 'block';
                    } else if (data.Visitor_ID) { // Fallback: construct path if only Visitor_ID is available
                        // Use the public route for QR codes to avoid authentication issues
                        qrCodeImage.src = `/vms/public_visitor_image/${data.Visitor_ID}/qr`;
                        qrCodeContainer.style.display = 'block';
                    } else {
                        qrCodeContainer.style.display = 'none';
                    }
                
                    // Check if purpose contains 'Vendor Service' (case insensitive) and work_permit_certificate is not provided
                    console.log('Debug: Purpose =', data.purpose, ', Work Permit Certificate =', data.work_permit_certificate);
                    const isVendorService = data.purpose && data.purpose.toLowerCase().includes('vendor service') && (!data.work_permit_certificate || data.work_permit_certificate.trim() === '');
                    console.log('Debug: isVendorService =', isVendorService);
                                        
                    // Only showing ID card - other details removed for cleaner check-in experience
                
                    visitorDetailsDiv.style.display = 'block';
                    checkInButton.style.display = 'none'; // Hide original check-in button
                    cancelButton.style.display = 'inline-block'; // Show cancel button
                    rejectButton.style.display = 'inline-block'; // Show reject button
                    document.getElementById('print-id-card-button').style.display = 'inline-block'; // Show print button
                                        
                    if (isVendorService) {
                        // Show work permit upload form for vendor services without certificate
                        document.getElementById('work-permit-upload').style.display = 'block';
                        confirmCheckInButton.style.display = 'none'; // Hide check-in button
                    } else {
                        // Show check-in button for non-vendor services or vendor services with certificate
                        document.getElementById('work-permit-upload').style.display = 'none';
                        confirmCheckInButton.style.display = 'inline-block'; // Show confirm check-in button
                    }
                
                    currentVisitorId = visitorId; // Store the visitor ID for actions
                } else {
                    console.error("‚ùå VISITOR NOT FOUND OR ERROR");
                    console.error("Error Message:", data.message);
                    alert(data.message || "Error fetching visitor details.");
                    visitorDetailsDiv.style.display = 'none';
                    document.getElementById('print-id-card-button').style.display = 'none'; // Hide print button on error
                }
            } catch (error) {
                console.error("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ");
                console.error("‚ùå EXCEPTION IN FETCH");
                console.error("Error Type:", error.name);
                console.error("Error Message:", error.message);
                console.error("Error Stack:", error.stack);
                console.error("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ");
                
                // Handle timeout specifically
                if (error.name === 'TimeoutError' || error.message.includes('timed out')) {
                    alert("Request timed out. Please try again.");
                } else {
                    alert(`Error fetching visitor details: ${error.message}`);
                }
                
                visitorDetailsDiv.style.display = 'none';
                document.getElementById('print-id-card-button').style.display = 'none'; // Hide print button on error
            }
        }

        // Event listener for the main Check-in button (now "Scan QR for Check-in")
        checkInButton.addEventListener('click', () => {
            visitorDetailsDiv.style.display = 'none'; // Hide visitor details if shown
            startQrScanner(); // Start QR scanner
        });

        // Event listeners for the table's Check-in buttons
        checkInTableButtons.forEach(button => {
            button.addEventListener('click', () => {
                visitorDetailsDiv.style.display = 'none'; // Hide visitor details if shown
                stopQrScanner(); // Ensure scanner is stopped if it was somehow active
                startQrScanner(); // Always start QR scanner
            });
        });

        // Camera functionality for work permit document
        const workPermitVideo = document.getElementById('workPermitVideo');
        const workPermitCanvas = document.getElementById('workPermitCanvas');
        const startWorkPermitCameraBtn = document.getElementById('start-workPermit-camera');
        const captureWorkPermitBtn = document.getElementById('capture-workPermit-photo');
        const workPermitPreview = document.getElementById('workPermitPreview');
        const workPermitCapturedImage = document.getElementById('workPermitCapturedImage');
        let workPermitStream = null;
        
        // Camera functionality for safety measures checklist
        const safetyMeasuresVideo = document.getElementById('safetyMeasuresVideo');
        const safetyMeasuresCanvas = document.getElementById('safetyMeasuresCanvas');
        const startSafetyMeasuresCameraBtn = document.getElementById('start-safetyMeasures-camera');
        const captureSafetyMeasuresBtn = document.getElementById('capture-safetyMeasures-photo');
        const safetyMeasuresPreview = document.getElementById('safetyMeasuresPreview');
        const safetyMeasuresCapturedImage = document.getElementById('safetyMeasuresCapturedImage');
        let safetyMeasuresStream = null;
        
        // Start camera for work permit document
        if (startWorkPermitCameraBtn) {
            startWorkPermitCameraBtn.addEventListener('click', async () => {
                try {
                    // First, stop any existing stream to avoid conflicts
                    if (workPermitStream) {
                        workPermitStream.getTracks().forEach(track => track.stop());
                    }
                    
                    workPermitStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    workPermitVideo.srcObject = workPermitStream;
                    
                    // Ensure the video element is visible and playing
                    workPermitVideo.style.display = 'block';
                    workPermitVideo.play().catch(error => {
                        console.warn('Auto-play prevented:', error);
                        // If autoplay is prevented, we'll handle it by showing the video when user interacts
                    });
                    
                    startWorkPermitCameraBtn.style.display = 'none';
                    captureWorkPermitBtn.style.display = 'block';
                } catch (err) {
                    console.error('Error accessing camera:', err);
                    alert('Could not access the camera. Please ensure camera permissions are granted and that you are using HTTPS or localhost.');
                }
            });
        }
        
        // Capture photo of work permit document
        if (captureWorkPermitBtn) {
            captureWorkPermitBtn.addEventListener('click', () => {
                // Set canvas dimensions to match video
                workPermitCanvas.width = workPermitVideo.videoWidth;
                workPermitCanvas.height = workPermitVideo.videoHeight;
                
                // Add a small delay to ensure the video frame is rendered
                setTimeout(() => {
                    // Draw the current frame from video to canvas
                    workPermitCanvas.getContext('2d').drawImage(workPermitVideo, 0, 0, workPermitCanvas.width, workPermitCanvas.height);
                    
                    // Convert captured image to data URL
                    const imageDataUrl = workPermitCanvas.toDataURL('image/jpeg', 0.8);
                    workPermitPreview.src = imageDataUrl;
                    workPermitPreview.style.display = 'block';
                    
                    // Store the captured image data in the hidden input
                    workPermitCapturedImage.value = imageDataUrl;
                    
                    // Stop the camera stream
                    if (workPermitStream) {
                        workPermitStream.getTracks().forEach(track => track.stop());
                        workPermitStream = null;
                    }
                    workPermitVideo.style.display = 'none';
                    captureWorkPermitBtn.style.display = 'none';
                    startWorkPermitCameraBtn.style.display = 'block';
                    
                    alert('Photo captured successfully!');
                }, 100); // Small delay to ensure video frame is rendered
            });
        }
        
        // Start camera for safety measures checklist
        if (startSafetyMeasuresCameraBtn) {
            startSafetyMeasuresCameraBtn.addEventListener('click', async () => {
                try {
                    // First, stop any existing stream to avoid conflicts
                    if (safetyMeasuresStream) {
                        safetyMeasuresStream.getTracks().forEach(track => track.stop());
                    }
                    
                    safetyMeasuresStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    safetyMeasuresVideo.srcObject = safetyMeasuresStream;
                    
                    // Ensure the video element is visible and playing
                    safetyMeasuresVideo.style.display = 'block';
                    safetyMeasuresVideo.play().catch(error => {
                        console.warn('Auto-play prevented:', error);
                        // If autoplay is prevented, we'll handle it by showing the video when user interacts
                    });
                    
                    startSafetyMeasuresCameraBtn.style.display = 'none';
                    captureSafetyMeasuresBtn.style.display = 'block';
                } catch (err) {
                    console.error('Error accessing camera:', err);
                    alert('Could not access the camera. Please ensure camera permissions are granted and that you are using HTTPS or localhost.');
                }
            });
        }
        
        // Capture photo of safety measures checklist
        if (captureSafetyMeasuresBtn) {
            captureSafetyMeasuresBtn.addEventListener('click', () => {
                // Set canvas dimensions to match video
                safetyMeasuresCanvas.width = safetyMeasuresVideo.videoWidth;
                safetyMeasuresCanvas.height = safetyMeasuresVideo.videoHeight;
                
                // Add a small delay to ensure the video frame is rendered
                setTimeout(() => {
                    // Draw the current frame from video to canvas
                    safetyMeasuresCanvas.getContext('2d').drawImage(safetyMeasuresVideo, 0, 0, safetyMeasuresCanvas.width, safetyMeasuresCanvas.height);
                    
                    // Convert captured image to data URL
                    const imageDataUrl = safetyMeasuresCanvas.toDataURL('image/jpeg', 0.8);
                    safetyMeasuresPreview.src = imageDataUrl;
                    safetyMeasuresPreview.style.display = 'block';
                    
                    // Store the captured image data in the hidden input
                    safetyMeasuresCapturedImage.value = imageDataUrl;
                    
                    // Stop the camera stream
                    if (safetyMeasuresStream) {
                        safetyMeasuresStream.getTracks().forEach(track => track.stop());
                        safetyMeasuresStream = null;
                    }
                    safetyMeasuresVideo.style.display = 'none';
                    captureSafetyMeasuresBtn.style.display = 'none';
                    startSafetyMeasuresCameraBtn.style.display = 'block';
                    
                    alert('Safety measures checklist photo captured successfully!');
                }, 100); // Small delay to ensure video frame is rendered
            });
        }
        
        // Event listener for the Upload Work Permit button
        const uploadWorkPermitButton = document.getElementById('upload-work-permit-button');
        if (uploadWorkPermitButton) {
            uploadWorkPermitButton.addEventListener('click', () => {
                if (currentVisitorId) {
                    // Create a FormData object to send both visitor ID and file
                    const formData = new FormData();
                    formData.append('visitor_id', currentVisitorId);
                    
                    // Check if a captured image exists
                    if (workPermitCapturedImage.value) {
                        // Add CSRF token to form data
                        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                        formData.append('csrf_token', csrfToken);
                                        
                        // Convert data URL to Blob and append to form
                        fetch(workPermitCapturedImage.value)
                            .then(res => res.blob())
                            .then(blob => {
                                // Create a file from the blob
                                const file = new File([blob], `work_permit_${currentVisitorId}_${Date.now()}.jpg`, { type: 'image/jpeg' });
                                formData.append('work_permit_certificate', file);
                                                
                                // Submit the form with the captured image
                                submitWorkPermitForm(formData);
                            });
                    } else {
                        // Use file upload if no captured image
                        const fileInput = document.getElementById('work_permit_certificate');
                        if (fileInput.files.length > 0) {
                            // Add CSRF token to form data
                            const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                            formData.append('csrf_token', csrfToken);
                            
                            formData.append('work_permit_certificate', fileInput.files[0]);
                            submitWorkPermitForm(formData);
                        } else {
                            alert('Please select a file to upload or capture a photo using the camera.');
                        }
                    }
                } else {
                    alert("No visitor selected.");
                }
            });
        }
        
        // Helper function to submit work permit form
        function submitWorkPermitForm(formData) {
            fetch('{{ url_for("check_in_approval") }}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(async response => {
                // Check if response is JSON or HTML
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    // If not JSON, try to extract error message from HTML
                    const html = await response.text();
                    console.error('Non-JSON response received:', html);
                    throw new Error('Server returned an error page instead of JSON');
                }
            })
            .then(data => {
                if (data && data.success) {
                    alert(data.message || 'Work permit certificate uploaded successfully!');
                    // Hide the upload form and show the check-in button
                    document.getElementById('work-permit-upload').style.display = 'none';
                    document.getElementById('confirm-check-in-button').style.display = 'inline-block';
                    
                    // Reset form elements
                    document.getElementById('work_permit_certificate').value = '';
                    workPermitPreview.style.display = 'none';
                    workPermitCapturedImage.value = '';
                } else {
                    alert(data.message || 'Error uploading work permit certificate.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error uploading work permit certificate: ' + error.message);
            });
        }
        
        // Event listener for the Confirm Check-in button (now "OK")
        confirmCheckInButton.addEventListener('click', () => {
            if (currentVisitorId) {
                document.getElementById('visitor_id').value = currentVisitorId;
                document.getElementById('check_in_form').submit();
            } else {
                alert("No visitor selected for check-in.");
            }
        });

        // Event listener for the Cancel button
        cancelButton.addEventListener('click', async () => {
            visitorDetailsDiv.style.display = 'none';
            stopQrScanner(); // Stop scanner if active
            confirmCheckInButton.style.display = 'none'; // Hide confirm button
            rejectButton.style.display = 'none'; // Hide reject button
            checkInButton.style.display = 'block'; // Show original check-in button
            cancelButton.style.display = 'none'; // Hide cancel button
            document.getElementById('print-id-card-button').style.display = 'none'; // Hide print button
            currentVisitorId = null; // Clear current visitor
        });

        // Event listener for the Reject button
        rejectButton.addEventListener('click', async () => {
            if (currentVisitorId) {
                const confirmReject = confirm("Are you sure you want to reject this visitor?");
                if (confirmReject) {
                    try {
                        const response = await fetch(`/reject_visitor_by_qrcode/${currentVisitorId}`, { method: 'POST' });
                        const data = await response.json();
                        if (response.ok && data.success) {
                            alert(data.message);
                            window.location.reload(); // Reload to update the list
                        } else {
                            alert(data.message || "Error rejecting visitor.");
                        }
                    } catch (error) {
                        console.error("Error rejecting visitor:", error);
                        alert("Error rejecting visitor.");
                    }
                }
            } else {
                alert("No visitor selected for rejection.");
            }
        });

        // Event listener for the Print ID Card button
        document.getElementById('print-id-card-button').addEventListener('click', () => {
            // Get the current visitor ID from the displayed visitor ID text
            const visitorId = document.getElementById('visitor-visitor-id').textContent;
            
            // Create image sources using the public routes
            const visitorImageSrc = `/vms/public_visitor_image/${visitorId}/photo`;
            const qrCodeImageSrc = `/vms/public_visitor_image/${visitorId}/qr`;
            
            // Clone the printable content
            const printableElement = document.getElementById('printable-id-card').cloneNode(true);
            
            // Update image sources in the cloned element to ensure they work in the new window
            const visitorImg = printableElement.querySelector('#visitor-image');
            const qrCodeImg = printableElement.querySelector('#qr-code-image');
            
            if (visitorImg) {
                visitorImg.src = visitorImageSrc;
            }
            
            if (qrCodeImg) {
                qrCodeImg.src = qrCodeImageSrc;
            }
            
            const printableContent = printableElement.outerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Visitor ID Card</title>');
            printWindow.document.write('<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">'); // Include Bootstrap CSS
            printWindow.document.write('<style>');
            printWindow.document.write('.id-card-container { border: 1px solid #ccc; padding: 20px; margin: 20px auto; width: 300px; text-align: center; font-family: Arial, sans-serif; }');
            printWindow.document.write('.id-card-container img { border-radius: 50%; width: 100px; height: 100px; object-fit: cover; margin-bottom: 10px; border: 2px solid #007bff; }');
            printWindow.document.write('.id-card-container h4 { margin-bottom: 5px; color: #343a40; }');
            printWindow.document.write('.id-card-container p { margin-bottom: 3px; font-size: 0.9em; color: #6c757d; }');
            printWindow.document.write('.id-card-container #qr-code-image { width: 120px; height: 120px; margin-top: 15px; }');
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(printableContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            
            // Wait for images to load before printing
            let imagesLoaded = 0;
            const totalImages = printableElement.querySelectorAll('img').length;
            
            if (totalImages === 0) {
                printWindow.print();
                return;
            }
            
            printableElement.querySelectorAll('img').forEach(img => {
                if (img.complete) {
                    imagesLoaded++;
                    if (imagesLoaded === totalImages) {
                        printWindow.print();
                    }
                } else {
                    img.onload = () => {
                        imagesLoaded++;
                        if (imagesLoaded === totalImages) {
                            printWindow.print();
                        }
                    };
                    img.onerror = () => {
                        imagesLoaded++;
                        if (imagesLoaded === totalImages) {
                            printWindow.print();
                        }
                    };
                }
            });
        });

        viewDetailsButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                const visitorId = event.target.dataset.visitorId;
                fetchVisitorDetailsAndShowActions(visitorId);
                stopQrScanner(); // Stop scanner if active when viewing details
            });
        });

        // Function to clear search fields and reload the page
        function clearSearch() {
            document.getElementById('searchTermInput').value = '';
            const url = new URL(window.location.href);
            url.search = ''; // Clear all search parameters
            window.location.href = url.toString(); // Navigate to the clean URL
        }

        // Event listener for the Clear Search button
        const clearSearchButton = document.getElementById('clearSearchButton');
        if (clearSearchButton) {
            clearSearchButton.addEventListener('click', clearSearch);
        }
    });
    </script>
    <form id="check_in_form" method="post" action="{{ url_for('check_in_approval') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" id="visitor_id" name="visitor_id">
    </form>
{% endblock %}
